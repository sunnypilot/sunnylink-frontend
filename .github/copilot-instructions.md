# Copilot Instructions for sunnylink-frontend

## Project Overview

sunnylink is a web-based remote management platform for comma devices running [sunnypilot](https://github.com/sunnypilot/sunnypilot), an open-source driver assistance system. This SvelteKit application provides a secure interface for device management, remote configuration, model switching, and settings backup/migration.

## Technology Stack

- **Framework**: SvelteKit with Svelte 5 (using runes: `$state`, `$derived`, `$effect`)
- **Language**: TypeScript with strict mode enabled
- **Styling**: Tailwind CSS v4 + DaisyUI components
- **Package Manager**: pnpm (version 9.12.0+)
- **Node Version**: >=22.12.0
- **Authentication**: Logto SSO integration
- **API Client**: OpenAPI-generated TypeScript clients with openapi-fetch
- **PWA**: Progressive Web App with vite-plugin-pwa and Workbox
- **Testing**: Vitest with Playwright browser testing
- **Build Tool**: Vite

## Project Structure

```
src/
├── routes/              # SvelteKit pages and layouts
│   ├── dashboard/       # Main app dashboard and device management
│   ├── auth/           # Authentication flow pages
│   └── settings/       # App settings pages
├── lib/
│   ├── api/            # OpenAPI client wrappers and device communication
│   ├── components/     # Reusable Svelte components
│   ├── stores/         # Svelte reactive state stores
│   ├── types/          # TypeScript type definitions
│   ├── utils/          # Utility functions
│   ├── logto/          # Authentication logic
│   └── assets/         # Static assets
└── sunnylink/          # OpenAPI schemas (v0, v1)
```

## Coding Standards

### Code Style
- **Formatter**: Prettier with the following configuration:
  - Use tabs (not spaces)
  - Single quotes
  - No trailing commas
  - 100 character line width
  - Special plugins: prettier-plugin-svelte, prettier-plugin-tailwindcss
- **Type Safety**: Strict TypeScript mode with `noUncheckedIndexedAccess` enabled
- **Svelte 5**: Use modern runes syntax (`$state`, `$derived`, `$effect`) for reactive state

### Best Practices
- Prefer functional components and composition over class-based patterns
- Use Svelte 5 runes for reactive state management instead of legacy stores where possible
- Keep components focused and reusable
- Use TypeScript types from OpenAPI schemas when working with API data
- Follow SvelteKit conventions for routing and data loading
- Use DaisyUI components for consistent UI patterns

### File Naming
- Svelte components: PascalCase (e.g., `DeviceCard.svelte`)
- Routes: lowercase with hyphens (e.g., `device-list`)
- TypeScript files: camelCase (e.g., `deviceApi.ts`)
- Test files: `*.spec.ts` or `*.svelte.spec.ts`

## Build & Development

### Setup
```bash
# Install dependencies
pnpm install --frozen-lockfile

# Start development server
pnpm dev
```

### Available Scripts
- `pnpm dev` - Start development server with hot reload
- `pnpm build` - Build for production (output to `build/`)
- `pnpm preview` - Preview production build locally
- `pnpm check` - Run svelte-check for type checking
- `pnpm check:watch` - Run type checking in watch mode
- `pnpm lint` - Check code formatting with Prettier
- `pnpm format` - Format code with Prettier
- `pnpm test` - Run all tests
- `pnpm test:unit` - Run tests in watch mode

### Testing
- Test framework: Vitest with two test projects:
  - **Client tests**: Browser-based tests using Playwright (`*.svelte.{test,spec}.{js,ts}`)
  - **Server tests**: Node-based tests (`*.{test,spec}.{js,ts}` excluding Svelte tests)
- All tests must include assertions (`expect.requireAssertions: true`)
- Test files should be colocated with the code they test
- Use `describe` and `it` blocks for test organization

### CI/CD
- **Deployment**: GitHub Actions workflow deploys to GitHub Pages on push to `main`
- **Build Requirements**: 
  - Node 22
  - pnpm 9.12.0
  - Environment variables for API endpoints and Logto configuration
- **Build Output**: Static site generated by `@sveltejs/adapter-static`

## Key Features & Architecture

### Device Management
- Multi-device support with real-time online/offline status
- WebSocket communication for device commands
- Custom device aliasing and organization
- Device registration, deregistration, and migration flows

### Settings Configuration
- 7 categories of configurable parameters:
  - Device (language, units, recording)
  - Toggles (feature switches)
  - Steering (MADS, torque control)
  - Cruise (speed control, ACC)
  - Visuals (UI customization)
  - Developer (debugging tools)
  - Other (navigation, maps)
- Real-time setting synchronization with devices

### Model Management
- Browse and switch driving models remotely
- Safety enforcement: offroad mode required for model changes
- Force offroad option with user warnings

### Backup & Migration
- JSON-based settings backup
- Cross-device settings migration
- Progress tracking for operations

## Common Tasks

### Adding a New Route
1. Create route directory in `src/routes/`
2. Add `+page.svelte` for the page component
3. Add `+page.ts` or `+page.server.ts` for data loading if needed
4. Follow existing patterns for layout and styling

### Adding a New API Endpoint
1. Update OpenAPI schema in `src/sunnylink/v0/` or `v1/`
2. Regenerate TypeScript types if needed
3. Add wrapper functions in `src/lib/api/` following existing patterns
4. Use openapi-fetch for type-safe API calls

### Adding a New Component
1. Create component in `src/lib/components/`
2. Use TypeScript for props and exports
3. Follow Svelte 5 runes syntax for reactive state
4. Use DaisyUI classes for styling consistency
5. Add unit tests if the component has complex logic

### Working with State
- Use Svelte 5 runes (`$state`, `$derived`, `$effect`) for local component state
- Use stores in `src/lib/stores/` for shared application state
- Follow reactive patterns and avoid imperative updates

## Security & Environment

### Environment Variables
- API endpoints configured via `PUBLIC_API_URL`
- Logto authentication via `PUBLIC_LOGTO_ENDPOINT` and `PUBLIC_LOGTO_APP_ID`
- All public env vars must be prefixed with `PUBLIC_`

### Security Practices
- Never commit secrets or API keys
- Use Logto SSO for authentication
- Validate all user inputs
- Follow secure WebSocket communication patterns

## Special Instructions

### Documentation
- Update README.md when adding major features
- Document new API patterns in code comments when they differ from existing patterns
- Keep this copilot-instructions.md file updated with architectural changes

### Dependencies
- Use pnpm for all package management
- Prefer updating existing dependencies over adding new ones
- Check compatibility with Node 22 and pnpm 9.12.0+
- Test thoroughly after dependency updates

### Performance
- Minimize bundle size (SvelteKit static adapter optimization)
- Use lazy loading for routes when appropriate
- Optimize images and assets for PWA
- Test PWA functionality after changes to service worker

## Issue Workflow

When working on issues:
1. Read the entire issue description and comments carefully
2. Understand the feature requirements or bug context
3. Check existing code patterns before implementing new solutions
4. Run `pnpm check` and `pnpm lint` before committing
5. Add or update tests for new functionality
6. Test in development environment (`pnpm dev`)
7. Ensure build succeeds (`pnpm build`)
8. Document significant changes in commit messages

## Review Checklist

Before considering work complete:
- [ ] Code follows Prettier formatting (tabs, single quotes, 100 char width)
- [ ] TypeScript strict mode passes with no errors
- [ ] All tests pass (`pnpm test`)
- [ ] Build succeeds (`pnpm build`)
- [ ] Code follows Svelte 5 runes patterns
- [ ] Changes are documented if they affect public APIs or major features
- [ ] No sensitive data or secrets committed
